#!/data/data/com.termux/files/usr/bin/sh
set -eu

URL="${1:-}"
[ -n "$URL" ] || exit 0

TITLE="Media link"
ACTIONS_CSV="Listen in background,Download,Download audio"

OUTDIR="${HOME}/storage/shared/Movies/yt-dlp"

pick_action() {
  termux-dialog radio -t "$TITLE" -v "$ACTIONS_CSV" 2>/dev/null \
    | jq -r '.text // empty' 2>/dev/null
}

ensure_outdir() {
  if [ ! -d "${HOME}/storage/shared" ]; then
    echo "Shared storage not set up. Run: termux-setup-storage" >&2
    exit 1
  fi
  mkdir -p "$OUTDIR"
}

media_scan() {
  command -v termux-media-scan >/dev/null 2>&1 && termux-media-scan "$OUTDIR" || true
}

listen() {
  mpv --no-video "$URL"
  rc=$?
  [ "$rc" -eq 4 ] && exit 0
  exit "$rc"
}

download_video() {
  ensure_outdir
  yt-dlp -P "$OUTDIR" -o '%(title).200B [%(id)s].%(ext)s' "$URL"
  media_scan
}

download_audio() {
  ensure_outdir
  # Prefer best audio; if postprocessing is available it will extract; otherwise fall back gracefully.
  yt-dlp -x --audio-quality 0 -P "$OUTDIR" -o '%(title).200B [%(id)s].%(ext)s' "$URL"
  media_scan
}

action="$(pick_action)"
[ -n "$action" ] || exit 0

case "$action" in
  "Listen in background") listen ;;
  "Download") download_video ;;
  "Download audio") download_audio ;;
  *) exit 0 ;;
esac
