#!/data/data/com.termux/files/usr/bin/sh
set -eu

URL="${1:-}"
[ -n "$URL" ] || exit 0

TITLE="YouTube link"
ACTIONS_CSV="Listen in background,Download,Download audio"

# Shared storage path (Termux exposes this after `termux-setup-storage`)
OUTDIR="${HOME}/storage/shared/Movies/yt-dlp"

pick_action() {
  termux-dialog radio -t "$TITLE" -v "$ACTIONS_CSV" 2>/dev/null \
    | jq -r '.text // empty' 2>/dev/null
}

listen() {
  mpv --no-video "$URL"
  rc=$?
  [ "$rc" -eq 4 ] && exit 0
  exit "$rc"
}

ensure_outdir() {
  if [ ! -d "${HOME}/storage/shared" ]; then
    echo "Shared storage not set up. Run: termux-setup-storage" >&2
    exit 1
  fi
  mkdir -p "$OUTDIR"
}

download() {
  ensure_outdir

  # Store as: Title [id].ext (safe-ish and avoids collisions)
  yt-dlp -P "$OUTDIR" -o '%(title).200B [%(id)s].%(ext)s' "$URL"

  # Nudge Android to index new files (Termux:API)
  command -v termux-media-scan >/dev/null 2>&1 && termux-media-scan "$OUTDIR" || true
}

action="$(pick_action)"
[ -n "$action" ] || exit 0

case "$action" in
  "Listen in background") listen ;;
  "Download") download ;;
  "Download audio") exit 0 ;; # TODO later
  *) exit 0 ;;
esac
