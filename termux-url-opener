#!/data/data/com.termux/files/usr/bin/sh
set -eu

# Error handler function
handle_error() {
  local exit_code=$?
  echo ""
  echo "========================================"
  echo "ERROR: Command failed with exit code $exit_code"
  echo "========================================"
  echo ""
  read -p "Press ENTER to exit..."
  exit $exit_code
}

# Set up error trap
trap 'handle_error' ERR

URL="${1:-}"
[ -n "$URL" ] || exit 0

TITLE="Media link"
ACTIONS_CSV="Listen in background,Download,Download audio"

OUTDIR="${HOME}/storage/shared/Movies/yt-dlp"

pick_action() {
  termux-dialog radio -t "$TITLE" -v "$ACTIONS_CSV" 2>/dev/null \
    | jq -r '.text // empty' 2>/dev/null
}

ensure_outdir() {
  if [ ! -d "${HOME}/storage/shared" ]; then
    echo "Shared storage not set up. Run: termux-setup-storage" >&2
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
  mkdir -p "$OUTDIR"
}

media_scan() {
  command -v termux-media-scan >/dev/null 2>&1 && termux-media-scan "$OUTDIR" || true
}

listen() {
  if ! mpv --no-video "$URL"; then
    rc=$?
    echo ""
    echo "ERROR: mpv failed to play URL!"
    echo ""
    read -p "Press ENTER to exit..."
    [ "$rc" -eq 4 ] && exit 0
    exit "$rc"
  fi
  exit 0
}

download_video() {
  ensure_outdir
  if ! yt-dlp -P "$OUTDIR" -o '%(title).200B [%(id)s].%(ext)s' "$URL"; then
    echo ""
    echo "ERROR: Video download failed!"
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
  media_scan
}

download_audio() {
  ensure_outdir
  # Prefer best audio; if postprocessing is available it will extract; otherwise fall back gracefully.
  if ! yt-dlp -x --audio-quality 0 -P "$OUTDIR" -o '%(title).200B [%(id)s].%(ext)s' "$URL"; then
    echo ""
    echo "ERROR: Audio download failed!"
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
  media_scan
}

action="$(pick_action)"
[ -n "$action" ] || exit 0

case "$action" in
  "Listen in background") listen ;;
  "Download") download_video ;;
  "Download audio") download_audio ;;
  *) exit 0 ;;
esac
