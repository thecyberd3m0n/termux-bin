#!/data/data/com.termux/files/usr/bin/bash
set -eu

# Error handler function
handle_error() {
  local exit_code=$?
  echo ""
  echo "========================================"
  echo "ERROR: Command failed with exit code $exit_code"
  echo "========================================"
  echo ""
  read -p "Press ENTER to exit..."
  exit $exit_code
}

# Set up error trap
trap 'handle_error' ERR

INPUT="${1:-}"

# Validate input
if [ -z "$INPUT" ] || [ ! -f "$INPUT" ]; then
  termux-toast "Error: no input file" 2>/dev/null || echo "Error: no input file: '$INPUT'" >&2
  echo ""
  read -p "Press ENTER to exit..."
  exit 1
fi

###########################################
# Helper functions
###########################################
pick_action() {
  termux-dialog radio -t "Video Editor" -v "Compress video,Prompt the script and process,AI Interactive mode" 2>/dev/null \
    | jq -r '.text // empty' 2>/dev/null
}

get_file_info() {
  # Duration
  DUR_RAW=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$INPUT" 2>/dev/null)
  DUR=1
  if echo "$DUR_RAW" | grep -Eq '^[0-9]'; then
    T=$(printf "%.0f" "$DUR_RAW")
    [ "$T" -gt 0 ] && DUR=$T
  fi

  # File info
  SIZE_BYTES=$(stat -c%s "$INPUT")
  SIZE_MB=$(awk "BEGIN{printf \"%.0f\", $SIZE_BYTES/1048576}")
  
  RES=$(ffprobe -v error -select_streams v:0 \
        -show_entries stream=width,height \
        -of csv=p=0:s=x "$INPUT" 2>/dev/null)

  CODEC=$(ffprobe -v error -select_streams v:0 \
          -show_entries stream=codec_name \
          -of csv=p=0 "$INPUT" 2>/dev/null)
}

ensure_outdir() {
  OUTDIR="/sdcard/Movies/compressed"
  if [ ! -d "/sdcard" ]; then
    termux-toast "Shared storage not set up" 2>/dev/null || echo "Shared storage not set up. Run: termux-setup-storage" >&2
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
  mkdir -p "$OUTDIR"
}

media_scan() {
  command -v termux-media-scan >/dev/null 2>&1 && termux-media-scan "$OUTDIR" || true
}

pick_compression_percentage() {
  local current_size="$1"
  
  termux-dialog text \
    -t "Current size: ${current_size} MB. Compress to what %?" \
    -i "50" 2>/dev/null \
    | jq -r '.text // empty' 2>/dev/null
}

pick_user_prompt() {
  local filename="$1"
  
  termux-dialog text \
    -t "AI Prompt for: ${filename}" \
    -i "compress this video to webm" 2>/dev/null \
    | jq -r '.text // empty' 2>/dev/null
}

ai_process_file() {
  local input_file="$1"
  local user_prompt="$2"
  
  # Check if copilot CLI is available
  if ! command -v copilot >/dev/null 2>&1; then
    termux-toast "GitHub Copilot CLI not installed. Run: npm install -g @github/copilot" 2>/dev/null || \
      echo "Error: GitHub Copilot CLI not installed." >&2
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
  
  # Create tmp directory and copy file there
  TMP_DIR="$HOME/tmp"
  mkdir -p "$TMP_DIR"
  
  # Get file name and extension
  local filename="${input_file##*/}"
  local base="${filename%.*}"
  local ext="${filename##*.}"
  
  # Copy input file to tmp
  local tmp_input="$TMP_DIR/$filename"
  cp "$input_file" "$tmp_input"
  
  # Prepare output directory
  local output_dir="/sdcard/Movies/processed"
  mkdir -p "$output_dir" 2>/dev/null || true
  
  # Build the AI prompt with context
  local ai_prompt="${user_prompt} (input file: ${tmp_input}, output file location: ${output_dir}/${base}_processed.${ext}, environment: Termux/bash)"
  
  # Show notification
  termux-toast "Processing with AI..." 2>/dev/null || echo "Processing with AI..."
  
  # Run copilot in non-interactive mode and capture the command
  local copilot_response
  if ! copilot_response=$(copilot -p "$ai_prompt" 2>&1); then
    echo ""
    echo "ERROR: Copilot command failed!"
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
  
  # Extract and execute the command
  # Copilot CLI in -p mode will suggest commands
  if [ -n "$copilot_response" ]; then
    termux-toast "Executing AI-generated command..." 2>/dev/null || echo "Executing: $copilot_response"
    
    # Execute the command in bash
    if ! eval "$copilot_response"; then
      echo ""
      echo "ERROR: AI-generated command failed!"
      echo "Command was: $copilot_response"
      echo ""
      read -p "Press ENTER to exit..."
      exit 1
    fi
    
    # Scan media library
    command -v termux-media-scan >/dev/null 2>&1 && termux-media-scan "$output_dir" || true
    
    # Show completion
    termux-toast "AI processing complete!" 2>/dev/null || echo "Processing complete!"
  else
    termux-toast "No command generated by AI" 2>/dev/null || echo "Error: No command generated"
    echo ""
    read -p "Press ENTER to exit..."
    exit 1
  fi
}

ai_interactive_mode() {
  local input_file="$1"
  
  # Check if copilot CLI is available
  if ! command -v copilot >/dev/null 2>&1; then
    echo "Error: GitHub Copilot CLI not installed."
    echo "Install with: npm install -g @github/copilot"
    read -p "Press ENTER to exit."
    exit 1
  fi
  
  # Create tmp directory and copy file there
  TMP_DIR="$HOME/tmp"
  mkdir -p "$TMP_DIR"
  
  # Get file name and extension
  local filename="${input_file##*/}"
  local base="${filename%.*}"
  local ext="${filename##*.}"
  
  # Copy input file to tmp
  local tmp_input="$TMP_DIR/$filename"
  cp "$input_file" "$tmp_input"
  
  # Prepare output directory
  local output_dir="/sdcard/Movies/processed"
  mkdir -p "$output_dir" 2>/dev/null || true
  
  # Clear screen and show context
  clear
  echo "========================================"
  echo "  AI Interactive Mode"
  echo "========================================"
  echo ""
  echo "Input file:  $tmp_input"
  echo "Output dir:  $output_dir"
  echo "Suggested output: ${output_dir}/${base}_processed.${ext}"
  echo ""
  echo "Starting GitHub Copilot CLI..."
  echo "You can now interact with AI directly."
  echo "========================================"
  echo ""
  
  # Change to tmp directory for context
  cd "$TMP_DIR"
  
  # Launch copilot in interactive mode
  # The user can type commands and interact directly
  copilot
  
  # After copilot exits, scan media library
  command -v termux-media-scan >/dev/null 2>&1 && termux-media-scan "$output_dir" || true
  
  echo ""
  echo "AI Interactive session ended."
  read -p "Press ENTER to exit."
}

###########################################
# Main flow
###########################################
action="$(pick_action)"
[ -n "$action" ] || exit 0

case "$action" in
  "Compress video")
    # Get file info
    get_file_info
    
    # Ask for compression percentage
    PERCENT="$(pick_compression_percentage "$SIZE_MB")"
    [ -n "$PERCENT" ] || exit 0
    
    # Validate percentage
    if ! echo "$PERCENT" | grep -Eq '^[0-9]+$'; then
      termux-toast "Invalid percentage: $PERCENT" 2>/dev/null || echo "Invalid percentage." >&2
      echo ""
      read -p "Press ENTER to exit..."
      exit 1
    fi
    
    if [ "$PERCENT" -le 0 ] || [ "$PERCENT" -ge 100 ]; then
      termux-toast "Percentage must be between 1 and 99" 2>/dev/null || echo "Percentage must be between 1 and 99." >&2
      echo ""
      read -p "Press ENTER to exit..."
      exit 1
    fi
    
    # Calculate target size based on percentage
    MB=$(awk "BEGIN{printf \"%.0f\", $SIZE_MB * $PERCENT / 100}")
    
    # Ensure minimum size
    [ "$MB" -lt 1 ] && MB=1

    
    # Compute bitrates
    TOTAL=$((MB*8000000/DUR))
    AUDIO=64000
    VIDEO=$((TOTAL-AUDIO))
    [ "$VIDEO" -lt 10000 ] && VIDEO=10000

    # Prepare output directory and file name
    ensure_outdir
    NAME="${INPUT##*/}"
    BASE="${NAME%.*}"
    EXT="${NAME##*.}"
    OUT="${OUTDIR}/${BASE}_compressed.${EXT}"

    # Show progress notification
    termux-toast "Compressing: ${NAME}" 2>/dev/null || true

    # Run ffmpeg (with fixed scale)
    if ! ffmpeg -i "$INPUT" \
      -c:v libx265 -b:v "$VIDEO" -preset medium \
      -pix_fmt yuv420p -vf "scale=1280:-2" \
      -c:a aac -b:a "$AUDIO" \
      "$OUT"; then
      echo ""
      echo "ERROR: Video compression failed!"
      echo ""
      read -p "Press ENTER to exit..."
      exit 1
    fi

    # Update media library
    media_scan

    # Show completion notification
    termux-toast "Done: ${OUT##*/}" 2>/dev/null || echo "Done. Saved as: $OUT"
    ;;
    
  "Prompt the script and process")
    # Get user prompt
    FILENAME="${INPUT##*/}"
    USER_PROMPT="$(pick_user_prompt "$FILENAME")"
    [ -n "$USER_PROMPT" ] || exit 0
    
    # Process file with AI
    ai_process_file "$INPUT" "$USER_PROMPT"
    ;;
    
  "AI Interactive mode")
    # Launch interactive AI session
    ai_interactive_mode "$INPUT"
    ;;
    
  *)
    exit 0
    ;;
esac
